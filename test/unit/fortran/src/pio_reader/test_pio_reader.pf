!This file contains tests for the PIO version of the CCPP NetCDF reader
!object (pio_reader.F90) as implemented in CAM-SIMA.

!+++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine starting_test()
    use funit

    use mpi, only: mpi_init, MPI_SUCCESS

    integer :: mpi_ierr

    ! Initialize MPI:
    ! NOTE: This must be done for the first test in the test suite.
    call mpi_init(mpi_ierr)

    @assertEqual(MPI_SUCCESS, mpi_ierr)

end subroutine starting_test

!+++++++++++++++++++++++++++++++++++++++++++++++++++++
!PIO reader object open/close file tests
!+++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine test_pio_reader_open_close_file()
    !Check that the PIO reader can open and
    !close a file successfully.
    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! File name for testing:
    ! NOTE:  This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    '../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc'

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Check that reader was allocated successfully:
    @assertAssociated(reader)

    ! Attempt to open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Check that file was opened successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Attempt to close file:
    call reader%close_file(errmsg, errcode)

    ! Check that file was closed successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Attempt to close the file again:
    call reader%close_file(errmsg, errcode)

    ! Check that closing an already-closed file does not cause an error:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Deallocate reader object:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_open_close_file

!----------------------------------------

@test
subroutine test_pio_reader_already_opened_file_err()
    ! Check that the PIO reader raises the correct error
    ! when attempting to open a file that is already opened.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! File name for testing:
    ! NOTE:  This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Trying to reuse pio_reader already used for: '"//fname//"'"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Attempt to open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to open file again:
    call reader%open_file(fname, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_already_opened_file_err

!----------------------------------------

@test
subroutine test_pio_reader_no_file_err()
    ! Check that the PIO reader raises the correct error
    ! when attempting to open a file that does not exist.

    use funit

    use pio,            only: PIO_NOERR

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! File name for testing
    ! NOTE: This file does not actually exist.
    character(len=*), parameter :: fname = &
    "glinda_the_good.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Error for file '"//fname//"' - message: No such file or directory"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Attempt to open non-existent file:
    call reader%open_file(fname, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_no_file_err

!+++++++++++++++++++++++++++++++++++++++++++++++++++++
!PIO reader object read variable tests
!+++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine test_pio_reader_1d_int_read()
    ! Check that the PIO reader can read a 1D integer variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: pressure(:)


    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)


    ! Read 1D integer variable:
    call reader%get_var("pressure", pressure, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(pressure))
    @assertEqual(59, size(pressure))

    ! Check that the variable's values are correct:
    @assertEqual(1711, sum(pressure))

    ! Perform test cleanup:
    deallocate(pressure)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_int_read

!----------------------------------------

@test
subroutine test_pio_reader_2d_int_read()
    ! Check that the PIO reader can read a 2D integer variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: minor_limits_gpt_lower(:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 2D integer variable:
    call reader%get_var("minor_limits_gpt_lower", minor_limits_gpt_lower, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(minor_limits_gpt_lower))
    @assertEqual(2, size(minor_limits_gpt_lower, dim=1))
    @assertEqual(34, size(minor_limits_gpt_lower, dim=2))

    ! Check that the variable's values are correct:
    @assertEqual(1727, sum(minor_limits_gpt_lower(1,:)))
    @assertEqual(11, sum(minor_limits_gpt_lower(:,1)))

    ! Perform test cleanup:
    deallocate(minor_limits_gpt_lower)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_2d_int_read
!----------------------------------------

@test
subroutine test_pio_reader_3d_int_read()
    ! Check that the PIO reader can read a 3D integer variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: key_species(:,:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 3D integer variable:
    call reader%get_var("key_species", key_species, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(key_species))
    @assertEqual(2, size(key_species, dim=1))
    @assertEqual(2, size(key_species, dim=2))
    @assertEqual(14, size(key_species, dim=3))

    ! Check that the variable's values are correct:
    @assertEqual(17, sum(key_species(1,1,:)))
    @assertEqual(2, sum(key_species(1,:,1)))
    @assertEqual(3, sum(key_species(:,1,1)))

    ! Perform test cleanup:
    deallocate(key_species)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_3d_int_read

!----------------------------------------

@test
subroutine test_pio_reader_1d_char_read()
    ! Check that the PIO reader can read a 1D character variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    character(len=:), allocatable :: gas_names(:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 1D character variable:
    call reader%get_var("gas_names", gas_names, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(gas_names))
    @assertEqual(32, len(gas_names))
    @assertEqual(19, size(gas_names))

    ! Check that the variable's values are correct:
    @assertEqual("h2o", trim(gas_names(1)))
    @assertEqual("co2", trim(gas_names(2)))
    @assertEqual("o3", trim(gas_names(3)))
    @assertEqual("n2o", trim(gas_names(4)))
    @assertEqual("co", trim(gas_names(5)))
    @assertEqual("ch4", trim(gas_names(6)))
    @assertEqual("o2", trim(gas_names(7)))
    @assertEqual("n2", trim(gas_names(8)))
    @assertEqual("ccl4", trim(gas_names(9)))
    @assertEqual("cfc11", trim(gas_names(10)))
    @assertEqual("cfc12", trim(gas_names(11)))
    @assertEqual("cfc22", trim(gas_names(12)))
    @assertEqual("hfc143a", trim(gas_names(13)))
    @assertEqual("hfc125", trim(gas_names(14)))
    @assertEqual("hfc23", trim(gas_names(15)))
    @assertEqual("hfc32", trim(gas_names(16)))
    @assertEqual("hfc134a", trim(gas_names(17)))
    @assertEqual("cf4", trim(gas_names(18)))
    @assertEqual("no2", trim(gas_names(19)))

    ! Perform test cleanup:
    deallocate(gas_names)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_char_read

!----------------------------------------

@test
subroutine test_pio_reader_0d_real_read()
    ! Check that the PIO reader can read a scalar real variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: press_ref_trop

    ! Variable value to compare against:
    real(kind_phys), parameter :: press_ref_trop_value = 9948.43156419_kind_phys

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 0D real variable:
    call reader%get_var("press_ref_trop", press_ref_trop, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(press_ref_trop))

    ! Check that the variable's value is correct:
    @assertEqual(press_ref_trop_value, press_ref_trop, tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(press_ref_trop)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_0d_real_read

!----------------------------------------

@test
subroutine test_pio_reader_1d_real_read()
    ! Check that the PIO reader can read a 1D real variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: press_ref(:)

    ! Variable value to compare against:
    real(kind_phys), parameter :: sum_press_ref = 604970.2016763_kind_phys

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 1D real variable:
    call reader%get_var("press_ref", press_ref, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(press_ref))
    @assertEqual(59, size(press_ref))

    ! Check that the variable's values are correct:
    @assertEqual(sum_press_ref, sum(press_ref), tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(press_ref)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_real_read

!----------------------------------------

@test
subroutine test_pio_reader_2d_real_read()
    ! Check that the PIO reader can read a 2D real variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: bnd_limits_wavenumber(:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Variable values to compare against:
    real(kind_phys), parameter :: bnd_limits_sum_pair = 3500._kind_phys
    real(kind_phys), parameter :: bnd_limits_sum_bnd = 160950._kind_phys

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 2D real variable:
    call reader%get_var("bnd_limits_wavenumber", bnd_limits_wavenumber, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(bnd_limits_wavenumber))
    @assertEqual(2, size(bnd_limits_wavenumber, dim=1))
    @assertEqual(14, size(bnd_limits_wavenumber, dim=2))

    ! Check that the variable's values are correct:
    ! (Example: sum of first row and first column)
    @assertEqual(bnd_limits_sum_pair, sum(bnd_limits_wavenumber(:,1)), tolerance=1.0e-7)
    @assertEqual(bnd_limits_sum_bnd, sum(bnd_limits_wavenumber(1,:)), tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(bnd_limits_wavenumber)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_2d_real_read
!----------------------------------------

@test
subroutine test_pio_reader_3d_real_read()
    ! Check that the PIO reader can read a 3D real variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: vmr_ref(:,:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Variable values to compare against:
    real(kind_phys), parameter :: vmr_ref_temp = 2._kind_phys
    real(kind_phys), parameter :: vmr_ref_absb = 1.99036093_kind_phys
    real(kind_phys), parameter :: vmr_ref_alay = 14._kind_phys

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 3D real variable:
    call reader%get_var("vmr_ref", vmr_ref, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(vmr_ref))
    @assertEqual(2, size(vmr_ref, dim=1))
    @assertEqual(20, size(vmr_ref, dim=2))
    @assertEqual(14, size(vmr_ref, dim=3))

    ! Check that the variable's values are correct:
    ! (Example: sum of first row and first column)
    @assertEqual(vmr_ref_temp, sum(vmr_ref(:,1,1)), tolerance=1.0e-7)
    @assertEqual(vmr_ref_absb, sum(vmr_ref(1,:,1)), tolerance=1.0e-7)
    @assertEqual(vmr_ref_alay, sum(vmr_ref(1,1,:)), tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(vmr_ref)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_3d_real_read

!----------------------------------------

@disable
! Reading a 4D real variable works in a normal
! CAM-SIMA build, but not in this pFUnit build (at least for GCCv13).
! Thus going ahead and leaving this disabled for now
! until more experimentation can be done.
subroutine test_pio_reader_4d_real_read_with_dims()
    ! Check that the PIO reader can read a 4D real variable
    ! from a file successfully, and that the dimensions are correct.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    !real(kind_phys), allocatable :: aero_salt_tbl(:,:,:,:)
    real(kind_phys), allocatable :: kmajor(:,:,:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    !character(len=*), parameter :: fname = &
    !"../../../rrtmgp-data/rrtmgp-aerosols-merra-sw.nc"

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Variable values to compare against:
    !real(kind_phys), parameter :: aero_salt_nval = 5.47319616_kind_phys
    !real(kind_phys), parameter :: aero_salt_nrh  = 5321.2595172_kind_phys
    !real(kind_phys), parameter :: aero_salt_nbin = 2468.15620565_kind_phys
    !real(kind_phys), parameter :: aero_salt_nbnd = 17700.470763_kind_phys

    real(kind_phys), parameter :: kmajor_temp = 1.1852394e-21_kind_phys
    real(kind_phys), parameter :: kmajor_pint = 3.82458752e-21_kind_phys
    real(kind_phys), parameter :: kmajor_mixf = 2.32129131e-21_kind_phys
    real(kind_phys), parameter :: kmajor_gpt = 2.62610317e-15_kind_phys

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 4D real variable:
    !call reader%get_var("aero_salt_tbl", aero_salt_tbl, errmsg, errcode)
    call reader%get_var("kmajor", kmajor, errmsg, errcode)

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:

    !@assertTrue(allocated(aero_salt_tbl))
    !@assertTrue(size(aero_salt_tbl, dim=1) == 3)
    !@assertTrue(size(aero_salt_tbl, dim=2) == 36)
    !@assertTrue(size(aero_salt_tbl, dim=3) == 5)
    !@assertTrue(size(aero_salt_tbl, dim=4) == 14)

    @assertTrue(allocated(kmajor))
    @assertEqual(112, size(kmajor, dim=1))
    @assertEqual(9, size(kmajor, dim=2))
    @assertEqual(60, size(kmajor, dim=3))
    @assertEqual(14, size(kmajor, dim=4))


    ! Check that the variable's values are correct:
    ! (Example: sum of first row and first column)
    !write(*,*) "aero_salt_tbl sum values = ", sum(aero_salt_tbl(:,1,1,1)), &
    !            sum(aero_salt_tbl(1,:,1,1)), &
    !            sum(aero_salt_tbl(1,1,:,1)), &
    !            sum(aero_salt_tbl(1,1,1,:))
    !write(*,*) "aero_salt_tbl bin values", aero_salt_tbl(1,1,:,1)

    !@assertEqual(aero_salt_nval, sum(aero_salt_tbl(:,1,1,1)), tolerance=1.0e-7)
    !@assertEqual(aero_salt_nrh, sum(aero_salt_tbl(1,:,1,1)), tolerance=1.0e-7)
    !@assertEqual(aero_salt_nbin, sum(aero_salt_tbl(1,1,:,1)), tolerance=1.0e-7)
    !@assertEqual(aero_salt_nbnd, sum(aero_salt_tbl(1,1,1,:)), tolerance=1.0e-7)

    @assertRelativelyEqual(kmajor_gpt, sum(kmajor(:,1,1,1)), tolerance=1.0e-7)
    @assertRelativelyEqual(kmajor_mixf, sum(kmajor(1,:,1,1)), tolerance=1.0e-7)
    @assertRelativelyEqual(kmajor_pint, sum(kmajor(1,1,:,1)), tolerance=1.0e-7)
    @assertRelativelyEqual(kmajor_temp, sum(kmajor(1,1,1,:)), tolerance=1.0e-7)

    ! Perform test cleanup:
    !deallocate(aero_salt_tbl)
    deallocate(kmajor)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_4d_real_read_with_dims

!+++++++++++++++++++++++++++++++++++++++++++++++++++++
!PIO reader variable read error tests
!+++++++++++++++++++++++++++++++++++++++++++++++++++++

!NOTE:  These tests should be repeated for each variable type,
! at least until Fortran supports doing type and array rank
! polymorphism together.

@test
subroutine test_pio_reader_int_get_var_file_not_opened_err()

    ! Check that the PIO reader raises the correct error
    ! when attempting to read an integer variable from a file
    ! that is not opened.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: pressure(:)

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "File 'UNSET' is not open, need to call 'open_file' first."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Attempt to read variable without opening file:
    call reader%get_var("pressure", pressure, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_int_get_var_file_not_opened_err

!----------------------------------------

@test
subroutine test_pio_reader_char_get_var_file_not_opened_err()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a character variable from
    ! a file that is not opened.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    character(len=:), allocatable :: gas_names(:)

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "File 'UNSET' is not open, need to call 'open_file' first."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Attempt to read variable without opening file:
    call reader%get_var("gas_names", gas_names, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_char_get_var_file_not_opened_err

!----------------------------------------

@test
subroutine test_pio_reader_real_get_var_file_not_opened_err()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a character variable from
    ! a file that is not opened.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    real(kind_phys), allocatable :: press_ref(:)

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "File 'UNSET' is not open, need to call 'open_file' first."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Attempt to read variable without opening file:
    call reader%get_var("press_ref", press_ref, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_real_get_var_file_not_opened_err

!----------------------------------------

@test
subroutine test_pio_reader_get_var_open_close_err()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable from a file
    ! that is opened and closed before attempting to read
    ! the variable.

    ! NOTE:  This behavior will be the same for all variable types,
    ! so we only need to test it once.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "File '"//fname//"' is not open, need to call 'open_file' first."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Close file:
    call reader%close_file(errmsg, errcode)

    ! Attempt to read variable after closing file:
    call reader%get_var("pressure", pressure, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_get_var_open_close_err

!-----------------------------------------

@test
subroutine test_pio_reader_int_get_var_missing_var()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read an integer variable that does not exist.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: missing_var(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Error for variable 'missing_var' - message: NetCDF: Variable not found"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read non-existent variable:
    call reader%get_var("missing_var", missing_var, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_int_get_var_missing_var

!-----------------------------------------

@test
subroutine test_pio_reader_char_get_var_missing_var()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read an character variable that
    ! does not exist.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    character(len=:), allocatable :: missing_var(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Error for variable 'missing_var' - message: NetCDF: Variable not found"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read non-existent variable:
    call reader%get_var("missing_var", missing_var, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_char_get_var_missing_var

!-----------------------------------------

@test
subroutine test_pio_reader_real_get_var_missing_var()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a real variable that does
    ! not exist.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    real(kind_phys), allocatable :: missing_var(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Error for variable 'missing_var' - message: NetCDF: Variable not found"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read non-existent variable:
    call reader%get_var("missing_var", missing_var, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_real_get_var_missing_var

!-----------------------------------------

@test
subroutine test_pio_reader_int_get_var_bad_rank()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read an integer variable with an
    ! incorrectly declared number of dimensions.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: pressure(:,:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Variable 'pressure' isn't declared with the correct number of dimensions. Expected 1 dimensions, but is declared with 2 dimensions."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with bad rank:
    call reader%get_var("pressure", pressure, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_int_get_var_bad_rank

!-----------------------------------------

@test
subroutine test_pio_reader_char_get_var_bad_rank()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a character variable with
    ! an incorrectly declared number of dimensions.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    character(len=:), allocatable :: gas_names(:,:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
        "Variable 'gas_names' isn't declared with the correct number of dimensions. Expected 2 dimensions, but is declared with 3 dimensions."


    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with bad rank:
    call reader%get_var("gas_names", gas_names, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_char_get_var_bad_rank

!-----------------------------------------

@test
subroutine test_pio_reader_real_get_var_bad_rank()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a real variable with
    ! an incorrectly declared number of dimensions.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: press_ref(:,:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Variable 'press_ref' isn't declared with the correct number of dimensions. Expected 1 dimensions, but is declared with 2 dimensions."


    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with bad rank:
    call reader%get_var("press_ref", press_ref, errmsg, errcode)

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_real_get_var_bad_rank

!+++++++++++++++++++++++++++++++++++++++++++++++++++++
!PIO reader variable subsetting tests
!+++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine test_pio_reader_1d_int_full_subset_read()
    ! Check that the PIO reader can read a 1D integer variable
    ! from a file successfully with subsetting that has
    ! a count array with the same rank as the output variable.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: pressure(:)


    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)


    ! Read 1D integer variable:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/1/), count=(/3/))

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(pressure))
    @assertEqual(3, size(pressure))

    ! Check that the variable's values are correct:
    @assertEqual(0, pressure(1))
    @assertEqual(1, pressure(2))
    @assertEqual(2, pressure(3))

    ! Perform test cleanup:
    deallocate(pressure)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_int_full_subset_read

!----------------------------------------

@test
subroutine test_pio_reader_2d_int_full_subset_read()
    ! Check that the PIO reader can read a 2D integer variable
    ! from a file successfully.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    integer, allocatable :: minor_limits_gpt_lower(:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 2D integer variable:
    call reader%get_var("minor_limits_gpt_lower", minor_limits_gpt_lower, errmsg, errcode, &
                        start=(/1,2/), count=(/2,3/))

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(minor_limits_gpt_lower))
    @assertEqual(2, size(minor_limits_gpt_lower, dim=1))
    @assertEqual(3, size(minor_limits_gpt_lower, dim=2))

    ! Check that the variable's values are correct:
    @assertEqual(1, minor_limits_gpt_lower(1,1))
    @assertEqual(10, minor_limits_gpt_lower(2,1))
    @assertEqual(1, minor_limits_gpt_lower(1,2))
    @assertEqual(10, minor_limits_gpt_lower(2,2))
    @assertEqual(1, minor_limits_gpt_lower(1,3))
    @assertEqual(10, minor_limits_gpt_lower(2,3))

    ! Now deallocate the variable and try a single value subset:
    deallocate(minor_limits_gpt_lower)

    call reader%get_var("minor_limits_gpt_lower", minor_limits_gpt_lower, errmsg, errcode, &
                        start=(/1,6/), count=(/1,1/))

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(minor_limits_gpt_lower))
    @assertEqual(1, size(minor_limits_gpt_lower, dim=1))
    @assertEqual(1, size(minor_limits_gpt_lower, dim=2))

    ! Check that the variable's values are correct:
    @assertEqual(11, minor_limits_gpt_lower(1,1))

    ! Perform test cleanup:
    deallocate(minor_limits_gpt_lower)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_2d_int_full_subset_read

!----------------------------------------

@test
subroutine test_pio_reader_1d_real_full_subset_read()
    ! Check that the PIO reader can read a 1D real variable
    ! from a file successfully with subsetting.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    !Variable to be read:
    real(kind_phys), allocatable :: press_ref(:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Variable values to compare against:
    real(kind_phys), parameter :: expected_press_ref_1 = 18127.2241875_kind_phys
    real(kind_phys), parameter :: expected_press_ref_2 = 14841.3159102_kind_phys

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 1D integer variable:
    call reader%get_var("press_ref", press_ref, errmsg, errcode, start=(/10/), count=(/2/))

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(press_ref))
    @assertEqual(2, size(press_ref))

    ! Check that the variable's values are correct:
    @assertEqual(expected_press_ref_1, press_ref(1), tolerance=1.0e-7)
    @assertEqual(expected_press_ref_2, press_ref(2), tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(press_ref)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_real_full_subset_read

!----------------------------------------

@test
subroutine test_pio_reader_3d_real_full_subset_read
    ! Check that the PIO reader can read a 3D real variable
    ! from a file successfully with subsetting.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: vmr_ref(:,:,:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Variable values to compare against:
    real(kind_phys), parameter :: expected_vmr_ref_1 = 1._kind_phys
    real(kind_phys), parameter :: expected_vmr_ref_2 = 1._kind_phys

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 1D integer variable:
    call reader%get_var("vmr_ref", vmr_ref, errmsg, errcode, start=(/1,1,1/), count=(/2,1,1/))

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(vmr_ref))
    @assertEqual(2, size(vmr_ref))

    ! Check that the variable's values are correct:
    @assertEqual(expected_vmr_ref_1, vmr_ref(1,1,1), tolerance=1.0e-7)
    @assertEqual(expected_vmr_ref_2, vmr_ref(2,1,1), tolerance=1.0e-7)

    ! Perform test cleanup:
    deallocate(vmr_ref)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_3d_real_full_subset_read

!----------------------------------------

@test
subroutine test_pio_reader_1d_char_full_subset_read()
    ! Check that the PIO reader can read a 3D real
    ! variable from a file successfully with subsetting.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    character(len=:), allocatable :: gas_names(:)

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    integer :: i !DEBUGGING -JN

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 1D character variable:
    ! NOTE: character variable subsetting requires passing in
    ! the string Length as the first dimension of the start and
    ! count arrays.
    call reader%get_var("gas_names", gas_names, errmsg, errcode, start=(/1,10/), count=(/32,6/))

    ! Check that the variable was read successfully:
    @assertEqual('', errmsg)
    @assertEqual(0, errcode)

    ! Check that the variable's properties are correct:
    @assertTrue(allocated(gas_names))
    @assertEqual(32, len(gas_names))
    @assertEqual(6, size(gas_names))

    ! DEBUGGING -JN
    do i=1, size(gas_names)
       write(*,*) "gas_names(", i, ") = '", trim(gas_names(i)), "'"
    end do

    ! Check that the variable's values are correct:
    @assertEqual("cfc11", trim(gas_names(1)))
    @assertEqual("cfc12", trim(gas_names(2)))
    @assertEqual("cfc22", trim(gas_names(3)))
    @assertEqual("hfc143a", trim(gas_names(4)))
    @assertEqual("hfc125", trim(gas_names(5)))
    @assertEqual("hfc23", trim(gas_names(6)))


    ! Perform test cleanup:
    deallocate(gas_names)
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_1d_char_full_subset_read

!+++++++++++++++++++++++++++++++++++++++++++++++++++++
!PIO reader variable subsetting error tests
!+++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine test_pio_reader_missing_start_argument()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "count" argument provided, but with no "start"
    ! argument.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Variable 'pressure' is being subsetted with 'count', but no 'start' was provided."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with missing start argument:
    call reader%get_var("pressure", pressure, errmsg, errcode, count=(/2/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_missing_start_argument

!-----------------------------------------

@test
subroutine test_pio_reader_missing_count_argument()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "start" argument provided, but with no "count"
    ! argument.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Variable 'pressure' is being subsetted with 'start', but no 'count' was provided."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with missing count argument:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/2/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_missing_count_argument

!-----------------------------------------  

@test
subroutine test_pio_reader_0d_real_subset_err()
    ! Check that the PIO reader can raise the
    ! correct error when a user attempts to subset
    ! a scalar (0-D) variable.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    use ccpp_kinds,     only: kind_phys

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    real(kind_phys), allocatable :: press_ref_trop

    ! File name for testing:
    ! NOTE: This specific file is added during the Github Actions workflow.
    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

     ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
    "Variable 'press_ref_trop' is a scalar variable, so start and count arguments must not be provided."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Read 0D real variable:
    call reader%get_var("press_ref_trop", press_ref_trop, errmsg, errcode, start=(/1/), count=(/1/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_0d_real_subset_err

!-----------------------------------------

@test
subroutine test_pio_reader_bad_num_start_elements()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "start" argument that has an incorrect number of elements.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
     "The number of elements in the 'start' array for variable 'pressure' does not match the number of dimensions.  Expected 1 elements, but got 2."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with incorrect number of start elements:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/1, 1/), count=(/2/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_bad_num_start_elements

!-----------------------------------------

@test
subroutine test_pio_reader_bad_num_count_elements()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "count" argument that has an incorrect number of elements.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error message:
    character(len=*), parameter :: expected_err_msg = &
     "The number of elements in the 'count' array for variable 'pressure' does not match the number of dimensions.  Expected 1 elements, but got 3."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with incorrect number of count elements:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/1/), count=(/1,1,1/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_bad_num_count_elements

!-----------------------------------------

@test
subroutine test_pio_reader_bad_start_element_range()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "start" argument that has an element out of range.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error messages:
    character(len=*), parameter :: expected_err_msg_neg = &
     "Element 1 of 'start' for variable 'pressure' is out of bounds.  Expected 1 to 59 but got -1."

    character(len=*), parameter :: expected_err_msg_huge = &
     "Element 1 of 'start' for variable 'pressure' is out of bounds.  Expected 1 to 59 but got 200."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with negative start element:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/-1/), count=(/1/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg_neg, trim(errmsg))

    ! Next attempt to read variable with too-large start element:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/200/), count=(/1/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg_huge, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_bad_start_element_range

!-----------------------------------------

@test
subroutine test_pio_reader_bad_count_element_range()
    ! Check that the PIO reader raises the correct error
    ! when attempting to read a variable with
    ! a "count" argument that has an element out of range.

    use funit

    use ccpp_io_reader, only: abstract_netcdf_reader_t
    use ccpp_io_reader, only: create_netcdf_reader_t

    class(abstract_netcdf_reader_t), pointer :: reader

    integer            :: errcode
    character(len=256) :: errmsg

    ! Variable to be read:
    integer, allocatable :: pressure(:)

    character(len=*), parameter :: fname = &
    "../../../rrtmgp-data/rrtmgp-gas-sw-g112.nc"

    ! Expected error messages:
    character(len=*), parameter :: expected_err_msg_neg = &
     "Element 1 of 'count' for variable 'pressure' is out of bounds.  Expected 1 to 59 but got -6."

    character(len=*), parameter :: expected_err_msg_huge = &
     "Element 1 of 'count' for variable 'pressure' is out of bounds.  Expected 1 to 59 but got 60."

    ! Begin test:

    reader => create_netcdf_reader_t()

    ! Open file:
    call reader%open_file(fname, errmsg, errcode)

    ! Attempt to read variable with negative start element:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/1/), count=(/-6/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg_neg, trim(errmsg))

    ! Next attempt to read variable with too-large start element:
    call reader%get_var("pressure", pressure, errmsg, errcode, start=(/1/), count=(/60/))

    ! Check that the correct error was raised:
    @assertNotEqual(0, errcode)
    @assertEqual(expected_err_msg_huge, trim(errmsg))

    ! Perform test cleanup:
    call reader%close_file(errmsg, errcode)
    deallocate(reader)
    nullify(reader)

end subroutine test_pio_reader_bad_count_element_range

!++++++++++++++++++++++++++++++++++++++++++++++++++++

@test
subroutine final_test()
    use funit

    use mpi, only: mpi_finalize, MPI_SUCCESS

    integer :: mpi_ierr

    ! Shutdown MPI:
    ! NOTE: This must be done for the last test in the test suite.
    call mpi_finalize(mpi_ierr)

    @assertEqual(MPI_SUCCESS, mpi_ierr)

end subroutine final_test
